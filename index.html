<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Расписание - Группа 22 (П.Б)</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        /* ... все ваши предыдущие стили остаются здесь без изменений ... */
        :root {
            --bg-color: #f0f2f5; --text-color: #1c1e21; --container-bg: #fff; --container-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); --accent-color: #0d47a1; --accent-color-light: #e3f2fd; --accent-color-medium: #bbdefb; --header-color: #1a237e; --border-color: #ddd; --subtle-text-color: #777; --break-bg-color: #fafafa; --progress-bar-bg-color: #e3f2fd; --progress-bar-color: #90caf9;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: flex-start; padding: 20px; min-height: 100vh; margin: 0; line-height: 1.5; transition: background-color 0.3s, color 0.3s; background-size: cover; background-position: center center; background-attachment: fixed;
        }
        .container {
            width: 100%; max-width: 800px; background-color: var(--container-bg); border-radius: 8px; box-shadow: var(--container-shadow); padding: 20px; transition: all 0.3s ease;
        }
        h1 { font-size: 1.6em; text-align: center; color: var(--accent-color); margin: 0 0 5px; cursor: pointer; }
        h2 { font-size: 1.1em; font-weight: 500; text-align: center; color: var(--accent-color); margin-bottom: 20px; }
        .controls { text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; }
        .btn {
            background-color: var(--accent-color-light); color: var(--accent-color); border: 1px solid var(--accent-color-medium); padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s;
        }
        .btn:hover { background-color: var(--accent-color-medium); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .schedule { margin-top: 20px; }
        .day {
            margin-bottom: 25px; border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; transition: all 0.3s ease;
        }
        .day.today { border-color: var(--accent-color); }
        .day h3 {
            margin-top: 0; color: var(--header-color); border-bottom: 2px solid var(--accent-color-light); padding-bottom: 8px;
        }
        table { 
            width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; 
        }
        td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        td:first-child { width: 25%; font-weight: 500; color: #555; }
        td:nth-child(2) { font-weight: 500; }
        td:last-child { text-align: right; font-style: italic; color: var(--subtle-text-color); }
        .no-classes { color: #999; font-style: italic; }
        .compact-class-list, .current-view-table { display: none; }
        body.compact-view .container { max-width: 98%; padding: 10px; }
        body.compact-view .schedule { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; }
        body.compact-view .day { margin-bottom: 0; padding: 8px; }
        body.compact-view .day.today { box-shadow: none; border-width: 2px; background-color: var(--accent-color-light); }
        body.compact-view .day.today h3 { color: var(--accent-color); }
        body.compact-view .day h3 { font-size: 1em; padding-bottom: 4px; margin-bottom: 4px; }
        body.compact-view .current-view-table { display: none; }
        body.compact-view .compact-class-list { display: block; }
        body.compact-view p { margin: 2px 0; font-size: 0.85em; line-height: 1.3; }
        body.compact-view .compact-time { font-weight: 600; }
        body.compact-view .compact-room { font-style: italic; }
        body.current-view .day:not(.today) { display: none; }
        body.current-view .compact-class-list { display: none; }
        body.current-view .current-view-table { display: table; }
        body.current-view .current-view-table td { padding: 6px 10px; } 
        .break-row { background-color: var(--break-bg-color); }
        .break-row td { text-align: center; font-style: italic; font-size: 0.9em; color: var(--subtle-text-color); }
        .current-active { background-color: var(--progress-bar-bg-color); }
        .current-active td { font-weight: bold !important; background-color: transparent !important; }
        .current-active td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .current-active td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        body.dark-theme {
            --bg-color: #121212; --text-color: #e0e0e0; --container-bg: #1e1e1e; --container-shadow: none; --accent-color: #FFF59D; --accent-color-light: #333123; --accent-color-medium: #504B30; --header-color: #FFF59D; --border-color: #444; --subtle-text-color: #999; --break-bg-color: #2a2a2a; --progress-bar-bg-color: #424230; --progress-bar-color: #757540; 
        }
        body.dark-theme .container { border: 1px solid var(--border-color); }
        body.dark-theme td { border-bottom: 1px solid #333; }
        body.dark-theme td:first-child { color: #bbb; }
        body.dark-theme .btn:hover { box-shadow: 0 0 5px rgba(255, 245, 157, 0.3); }
        body.background-image-active:not(.dark-theme) {
            --progress-bar-bg-color: rgba(227, 242, 253, 0.7); --progress-bar-color: rgba(144, 202, 249, 0.9);
        }
        body.background-image-active:not(.dark-theme) .container {
            background: transparent; border: none; box-shadow: none;
        }
        body.background-image-active:not(.dark-theme) .day {
            background: transparent; border: none; padding: 0;
        }
        body.background-image-active:not(.dark-theme) .day.today {
            border: 2px solid var(--accent-color); border-radius: 8px; padding: 15px; background-color: rgba(255, 255, 255, 0.4);
        }
        body.background-image-active:not(.dark-theme) .day h3 {
            border-bottom: 1px solid rgba(13, 71, 161, 0.3); background-color: rgba(255, 255, 255, 0.5); padding: 8px 12px; border-top-left-radius: 6px; border-top-right-radius: 6px;
        }
        body.background-image-active:not(.dark-theme) table {
            border-spacing: 0 4px;
        }
        body.background-image-active:not(.dark-theme) td {
            border-bottom: none; padding-top: 12px; padding-bottom: 12px;
        }
        body.background-image-active:not(.dark-theme) .current-view-table tr {
            background-color: rgba(255, 255, 255, 0.65); border-radius: 8px;
        }
        body.background-image-active:not(.dark-theme) .break-row {
            background-color: rgba(240, 242, 245, 0.7);
        }
        body.background-image-active:not(.dark-theme) .current-active {
            box-shadow: 0 0 10px rgba(13, 71, 161, 0.3);
        }
        body.background-image-active:not(.dark-theme) .btn {
            background-color: rgba(227, 242, 253, 0.7); border-color: var(--accent-color);
        }
        body.background-image-active:not(.dark-theme) .btn:hover {
            background-color: rgba(227, 242, 253, 1);
        }
        body.background-image-active:not(.dark-theme).compact-view .day {
            padding: 8px; border-radius: 8px; background-color: rgba(255, 255, 255, 0.7);
        }
        body.background-image-active:not(.dark-theme).compact-view .day.today {
            border: 2px solid var(--accent-color); background-color: rgba(227, 242, 253, 0.8);
        }
        body.dark-theme.background-image-active {
            --progress-bar-bg-color: rgba(80, 75, 48, 0.5); --progress-bar-color: rgba(159, 149, 96, 0.7);
        }
        body.dark-theme.background-image-active .container {
            background: transparent; border: none; box-shadow: none;
        }
        body.dark-theme.background-image-active .day {
            background: transparent; border: none; padding: 0;
        }
        body.dark-theme.background-image-active .day.today {
            border: 2px solid var(--accent-color); border-radius: 8px; padding: 15px; background-color: rgba(0, 0, 0, 0.2);
        }
        body.dark-theme.background-image-active .day h3 {
            border-bottom: 1px solid rgba(255, 245, 157, 0.5); background-color: rgba(0, 0, 0, 0.3); padding: 8px 12px; border-top-left-radius: 6px; border-top-right-radius: 6px;
        }
        body.dark-theme.background-image-active table {
            border-spacing: 0 4px;
        }
        body.dark-theme.background-image-active td {
            border-bottom: none; padding-top: 12px; padding-bottom: 12px;
        }
        body.dark-theme.background-image-active .current-view-table tr {
             background-color: rgba(0, 0, 0, 0.25); border-radius: 8px;
        }
        body.dark-theme.background-image-active .break-row {
            background-color: rgba(0, 0, 0, 0.4);
        }
        body.dark-theme.background-image-active .current-active {
            box-shadow: 0 0 10px rgba(255, 245, 157, 0.3);
        }
        body.dark-theme.background-image-active .btn {
            background-color: rgba(80, 75, 48, 0.5); border-color: var(--accent-color); color: var(--accent-color);
        }
        body.dark-theme.background-image-active .btn:hover {
            background-color: rgba(80, 75, 48, 0.8);
        }
        body.dark-theme.background-image-active.compact-view .day {
            padding: 8px; border-radius: 8px; background-color: rgba(0, 0, 0, 0.3);
        }
        body.dark-theme.background-image-active.compact-view .day.today {
             border: 2px solid var(--accent-color); background-color: rgba(80, 75, 48, 0.4);
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.visible { display: flex; }
        .modal-content {
            background-color: var(--container-bg); color: var(--text-color); padding: 25px; border-radius: 8px; width: 90%; max-width: 450px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 {
            margin-top: 0; color: var(--header-color); text-align: center; border-bottom: 2px solid var(--accent-color-light); padding-bottom: 10px;
        }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .setting-item label { font-weight: 500; }
        .setting-item select, .setting-item input {
            padding: 5px 8px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color);
        }
        /* НОВОЕ: Стили для переключателя */
        .setting-item .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .setting-item .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(18px); }

        .modal-actions {
            margin-top: 20px; display: flex; justify-content: space-between; gap: 10px;
        }
        .modal-actions .btn.danger { background-color: #fbe9e7; color: #c62828; border-color: #ffccbc; }
        .modal-actions .btn.danger:hover { background-color: #ffccbc; }
        body.dark-theme .modal-actions .btn.danger { background-color: #4e1a1a; color: #ff8a80; border-color: #803434;}
        body.dark-theme .modal-actions .btn.danger:hover { background-color: #803434;}

        /* НОВОЕ: Стили для офлайн-баннера */
        .offline-banner {
            display: none; /* Скрыт по умолчанию */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background-color: #c62828;
            color: white;
            text-align: center;
            font-weight: 500;
            z-index: 2000;
        }
        .offline-banner.visible {
            display: block;
        }
        .credits-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 1.5em;
            font-style: oblique;
            color: var(--subtle-text-color);
        }

        /* Стили для списка изменений */
        .changelog-list {
            list-style: none;
            padding-left: 0;
            margin-top: 15px;
        }

        .changelog-list li {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            line-height: 1.4;
        }

        .changelog-list li:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Расписание</h1>
    <h2>Y-group</h2>
    <div class="controls">
        <button id="toggle-view-btn" class="btn">Переключить вид</button>
        <button id="toggle-theme-btn" class="btn">Ночная тема</button>
        <button id="routing-btn" class="btn" onclick="window.location.href='routing.html'">Маршрутизация</button>
    </div>
    <div id="schedule-container" class="schedule"></div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Настройки</h3>
        <div class="setting-item">
            <label for="bg-toggle-btn">Фон:</label>
            <button id="bg-toggle-btn" class="btn">Цвет / Изображение</button>
        </div>
        <div class="setting-item">
            <label for="version-select">Версия:</label>
            <select id="version-select">
                <option value="latest">Latest</option>
                <option value="beta">Beta</option>
            </select>
        </div>
        <div class="setting-item">
            <label>Инфо</label>
            <button id="whats-new-btn" class="btn">What's New?</button>
        </div>
        <!-- НОВЫЙ ПУНКТ НАСТРОЕК -->
        <div class="setting-item">
            <label for="caching-toggle">Офлайн-режим:</label>
            <label class="switch">
                <input type="checkbox" id="caching-toggle">
                <span class="slider"></span>
            </label>
        </div>
        <div class="setting-item">
            <label for="date-picker">Тестовая дата:</label>
            <input type="date" id="date-picker">
        </div>
         <div class="setting-item">
            <label for="time-picker">Тестовое время:</label>
            <input type="time" id="time-picker">
        </div>
        <div class="setting-item">
            <label for="reset-datetime-btn">Сброс времени:</label>
            <button id="reset-datetime-btn" class="btn">Сбросить</button>
        </div>
        <div class="modal-actions">
            <button id="reset-settings-btn" class="btn danger">Сброс настроек</button>
            <button id="close-modal-btn" class="btn">Закрыть</button>
        </div>
        <div class="credits-footer">
            by technocat
        </div>
    </div>
</div>
<!-- НОВОЕ: Всплывающее окно "Что нового" -->
<div id="whats-new-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Что нового в приложении?</h3>
        
        <ul class="changelog-list">
            <li><b>Офлайн-режим:</b> Приложение теперь умеет работать без интернета, если включить офлайн мод в настройках.</li>
            <li><b>Новый дизайн с фоном:</b> Полностью переделан внешний вид для светлой и тёмной тем.</li>
            <li><b>Настройки:</b> Появилось меню настроек (тройной клик по надписи "Расписание")</li>
            <li><b>"Машина времени":</b> Добавлен интерфейс для установки тестовой даты и времени чтобы можно было поиграться.</li>
            <li><b>Фанатам ретро:</b> Оставлена старая версия, а то вдруг хочется</li>
            <li><b>Иконка сайта (Favicon):</b> Добавлена иконка для вкладок и закладок.</li>
            <li><b>Множество исправлений:</b> Улучшена куча всего</li>
        </ul>

        <div class="modal-actions">
            <button id="close-whats-new-btn" class="btn">Закрыть</button>
        </div>
    </div>
</div>

<!-- НОВЫЙ БАННЕР -->
<div id="offline-banner" class="offline-banner">
    Вы работаете в офлайн-режиме. Функциональность ограничена.
</div>

<script>
    // ИЗМЕНЕНО: Логика перенаправления теперь проверяет онлайн-статус
    (function() {
        // Проверяем интернет-соединение ПЕРЕД переадресацией
        if (navigator.onLine) {
            const savedVersion = localStorage.getItem('schedule_version');
            if (savedVersion && savedVersion !== 'latest') {
                const targetPage = savedVersion === 'alfa' ? 'alfaindex.html' : 'betaindex.html';
                if (!window.location.pathname.endsWith(targetPage)) {
                    window.location.href = targetPage;
                }
            }
        } else {
            console.log("Офлайн-режим. Переадресация отключена.");
        }
    })();

    // ... весь ваш старый JS-код (переменные, функции отрисовки и т.д.) ...
    let testDate = null; let testTime = null;
     const bellSchedules = { default: { 1: "8:15-9:35", 2: "9:45-11:05", 3: "11:15-12:35", 4: "13:00-14:20" } };
        const abbreviations = {
            "Математический анализ": "Мат. ан.",
            "Основы и методологии программирования": "ОиМП",
            "Английский язык": "Англ. яз.",
            "История белорусской государственности": "ИБГ",
            "Аналитическая геометрия": "Анал. геом.",
            "Белорусский язык": "Бел. яз.",
            "Дискретная математика и мат. логика": "ДМиМЛ",
            "Белорусский язык (проф. лексика)": "Бел. яз.",
            "Физическая культура": "Физ-ра",
            "Основы высшей алгебры": "ОВА",

        };

        const scheduleData = {
            1: {
                day: "Понедельник",
                classes: [
                    { time: "1", name: "Математический анализ", room: "521" },
                    { time: "2", name: "Основы и методологии программирования", room: "521" },
                    { time: "3", name: "Английский язык", room: "437 или 438" },
                    { time: "4", name: "История белорусской государственности", room: "542" }
                ]
            },
            2: {
                day: "Вторник",
                classes: [
                    { time: "1", name: "Математический анализ", room: "437" },
                    { time: "2", name: "Аналитическая геометрия", room: "521" },
                    { time: "3", name: "Аналитическая геометрия", room: "437" },
                ]
            },
            3: {
                day: "Среда",
                classes: [
                    { time: "1", name: "Дискретная математика и мат. логика", room: "521" },
                    { time: "2", name: "Английский язык", room: "ФМО, 1206 или 1013" },
                ]
            },
            4: {
                day: "Четверг",
                classes: [
                    { time: "1", name: "Основы высшей алгебры", room: "521" },
                    { time: "2", name: "Дискретная математика и мат. логика", room: "442" },
                    { time: "3", name: "Основы высшей алгебры", room: "442" },
                    { time: "4", name: "Физическая культура", room: "" }
                ]
            },
            5: {
                day: "Пятница",
                classes: [
                    { time: "1", name: "Математический анализ", room: "437" },
                    { time: "2", name: "Математический анализ", room: "521" },
                    { time: "3", name: "Основы и методологии программирования", room: "521" }
                ]
            },
            6: {
                day: "Суббота",
                classes: [
                    { time: "1", name: "Основы и методологии программирования", room: "Дзержинского 5, 1/4 эт." },
                    { time: "2", name: "Основы и методологии программирования", room: "Дзержинского 5, 1/4 эт." },
                    { time: "3", name: "История белорусской государственности", room: "521" },
                    { time: "4", name: "Физическая культура", room: "Спорткомплекс" }
                ]
            }
        };function getShortName(fullName) { return fullName.split(' / ').map(p => abbreviations[p.trim()] || p.trim()).join(' / '); }
    // НОВАЯ ФУНКЦИЯ для принудительного кэширования фонов
    function precacheBackgrounds() {
        fetch('WhiteGround.png').catch(err => console.error('Ошибка кэширования WhiteGround.png:', err));
        fetch('BlackGround.png').catch(err => console.error('Ошибка кэширования BlackGround.png:', err));
        fetch('favicon.ico').catch(err => console.error('Ошибка кэширования favicon.png:', err));
    }
    function parseTime(timeStr) { const [h, m] = timeStr.split(':').map(Number); return h * 60 + m; }
    function tickTestTime() { if (testTime) { testTime.setSeconds(testTime.getSeconds() + 1); } }
    function createDayElement(dayData, isToday, dayIndex) { const dayDiv = document.createElement('div'); dayDiv.className = 'day'; if (isToday) dayDiv.classList.add('today'); const title = document.createElement('h3'); title.textContent = dayData.day; dayDiv.appendChild(title); if (!dayData || dayData.classes.length === 0) { const noClasses = document.createElement('p'); noClasses.className = 'no-classes'; noClasses.textContent = 'Занятий нет'; dayDiv.appendChild(noClasses); } else { dayDiv.appendChild(createCurrentViewTable(dayData, dayIndex)); const compactList = document.createElement('div'); compactList.className = 'compact-class-list'; dayData.classes.forEach(cls => { const p = document.createElement('p'); p.innerHTML = `<span class="compact-time">${cls.time}:</span> ${getShortName(cls.name)} ${cls.room ? `<span class="compact-room">(${cls.room})</span>` : ''}`; compactList.appendChild(p); }); dayDiv.appendChild(compactList); } return dayDiv; }
    function createCurrentViewTable(dayData, dayIndex) { const schedule = bellSchedules[dayIndex] || bellSchedules.default; const table = document.createElement('table'); table.className = 'current-view-table'; const tbody = document.createElement('tbody'); const lessons = []; dayData.classes.forEach(cls => { const [startNum, endNum] = cls.time.split('-').map(Number); for (let i = startNum; i <= (endNum || startNum); i++) { if (schedule[i]) { const [startTime, endTime] = schedule[i].split('-'); lessons.push({ start: parseTime(startTime), end: parseTime(endTime), timeStr: schedule[i].replace('-', '–'), name: cls.name, room: cls.room }); } } }); lessons.sort((a, b) => a.start - b.start); for (let i = 0; i < lessons.length; i++) { const lesson = lessons[i]; const row = tbody.insertRow(); row.dataset.start = lesson.start; row.dataset.end = lesson.end; row.innerHTML = `<td>${lesson.timeStr}</td><td>${lesson.name}</td><td>${lesson.room ? `${lesson.room}` : ''}</td>`; if (lessons[i + 1]) { const breakDuration = lessons[i + 1].start - lesson.end; if (breakDuration > 0) { const breakRow = tbody.insertRow(); breakRow.className = 'break-row'; breakRow.dataset.start = lesson.end; breakRow.dataset.end = lessons[i + 1].start; breakRow.innerHTML = `<td colspan="3">Перемена (${breakDuration} мин.)</td>`; } } } table.appendChild(tbody); return table; }
    function updateHighlight() { const now = testTime ? new Date(testTime) : new Date(); const currentTime = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60; const todayElem = document.querySelector('.day.today .current-view-table'); if (!todayElem) return; const previouslyActive = todayElem.querySelector('.current-active'); if (previouslyActive) { previouslyActive.classList.remove('current-active'); previouslyActive.style.backgroundImage = ''; } const rows = todayElem.querySelectorAll('tbody tr'); for (const row of rows) { const start = parseInt(row.dataset.start, 10); const end = parseInt(row.dataset.end, 10); if (currentTime >= start && currentTime < end) { row.classList.add('current-active'); const totalDuration = end - start; const elapsed = currentTime - start; const percentage = Math.max(0, Math.min(100, (elapsed / totalDuration) * 100)); const styles = getComputedStyle(document.body); const barColor = styles.getPropertyValue('--progress-bar-color').trim(); const bgColor = styles.getPropertyValue('--progress-bar-bg-color').trim(); row.style.backgroundImage = `linear-gradient(to right, ${barColor} ${percentage}%, ${bgColor} ${percentage}%)`; break; } } }
    function renderSchedule() { const container = document.getElementById('schedule-container'); container.innerHTML = ''; const now = testDate ? new Date(testDate) : new Date(); const today = now.getDay() === 0 ? 7 : now.getDay();[1, 2, 3, 4, 5, 6].forEach(i => container.appendChild(createDayElement(scheduleData[i], i === today, i))); updateHighlight(); }
    
    document.addEventListener("DOMContentLoaded", function() {
        const body = document.body;

        // --- НОВЫЙ БЛОК: УПРАВЛЕНИЕ SERVICE WORKER И ОФЛАЙН-СТАТУСОМ ---
        const cachingToggle = document.getElementById('caching-toggle');
        const offlineBanner = document.getElementById('offline-banner');
        const versionSelect = document.getElementById('version-select');
        const whatsNewBtn = document.getElementById('whats-new-btn');
        const whatsNewModal = document.getElementById('whats-new-modal');
        const closeWhatsNewBtn = document.getElementById('close-whats-new-btn');
        // Функция для регистрации или разрегистрации SW
        function setupServiceWorker() {
            const isCachingEnabled = localStorage.getItem('schedule_caching_enabled') === 'true';
            if (isCachingEnabled && 'serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker зарегистрирован!', reg))
                    .catch(err => console.log('Ошибка регистрации Service Worker:', err));
            } else if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for(let registration of registrations) {
                        registration.unregister();
                        console.log('Service Worker удален.');
                    }
                });
            }
        }

        // Функция для обновления UI в зависимости от статуса сети
        function updateOfflineStatus() {
            if (!navigator.onLine) {
                offlineBanner.classList.add('visible');
                versionSelect.disabled = true;
            } else {
                offlineBanner.classList.remove('visible');
                versionSelect.disabled = false;
            }
        }

        // Обработчик переключателя кэширования
        cachingToggle.addEventListener('change', () => {
            localStorage.setItem('schedule_caching_enabled', cachingToggle.checked);
            setupServiceWorker();
            if (cachingToggle.checked) {
                precacheBackgrounds();
                alert("Офлайн-режим включен. Приложение будет закэшировано. Для завершения может потребоваться перезагрузка страницы.");
            } else {
                alert("Офлайн-режим отключен. Кэш будет очищен. Для вступления изменений в силу может потребоваться перезагрузка страницы.");
            }
        });
        
        // --- СТАРЫЙ КОД С НЕБОЛЬШИМИ ИЗМЕНЕНИЯМИ ---
        const toggleViewBtn = document.getElementById('toggle-view-btn');
        const toggleThemeBtn = document.getElementById('toggle-theme-btn');
        const views = ['current-view', 'compact-view'];
        let currentView = localStorage.getItem('schedule_view') || 'current-view';
        const buttonLabels = { 'compact-view': 'Текущий вид', 'current-view': 'Компактный вид' };
        function updateView() { body.classList.remove(...views); body.classList.add(currentView); toggleViewBtn.textContent = buttonLabels[currentView]; }
        toggleViewBtn.addEventListener('click', () => { currentView = body.classList.contains('compact-view') ? 'current-view' : 'compact-view'; localStorage.setItem('schedule_view', currentView); updateView(); });
        function applyTheme(theme) { body.classList.toggle('dark-theme', theme === 'dark'); toggleThemeBtn.textContent = theme === 'dark' ? 'Дневная тема' : 'Ночная тема'; applyBackground(); }
        toggleThemeBtn.addEventListener('click', () => { const newTheme = body.classList.contains('dark-theme') ? 'light' : 'dark'; localStorage.setItem('schedule_theme', newTheme); applyTheme(newTheme); });
        const settingsModal = document.getElementById('settings-modal');
        const h1 = document.querySelector('h1');
        let clickTimestamps = [];
        h1.addEventListener('click', () => { const now = Date.now(); clickTimestamps.push(now); clickTimestamps = clickTimestamps.filter(ts => now - ts < 1000); if (clickTimestamps.length >= 3) { settingsModal.classList.add('visible'); clickTimestamps = []; } });
        document.getElementById('close-modal-btn').addEventListener('click', () => { settingsModal.classList.remove('visible'); });
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { settingsModal.classList.remove('visible'); } });
        const bgToggleBtn = document.getElementById('bg-toggle-btn');
        function applyBackground() { const bgMode = localStorage.getItem('schedule_background_mode') || 'color'; if (bgMode === 'image') { const isDark = body.classList.contains('dark-theme'); const imageUrl = isDark ? 'BlackGround.png' : 'WhiteGround.png'; body.style.backgroundImage = `url('${imageUrl}')`; body.classList.add('background-image-active'); } else { body.style.backgroundImage = 'none'; body.classList.remove('background-image-active'); } }
        bgToggleBtn.addEventListener('click', () => { let currentMode = localStorage.getItem('schedule_background_mode') || 'color'; const newMode = currentMode === 'color' ? 'image' : 'color'; localStorage.setItem('schedule_background_mode', newMode); applyBackground(); });
        versionSelect.value = localStorage.getItem('schedule_version') || 'latest';
        versionSelect.addEventListener('change', (e) => { const newVersion = e.target.value; localStorage.setItem('schedule_version', newVersion); if (newVersion === 'latest' && !window.location.pathname.endsWith('index.html') && window.location.pathname !== '/') { window.location.href = 'index.html'; } else { window.location.reload(); } });
        document.getElementById('date-picker').addEventListener('change', (e) => { if (e.target.value) { const [year, month, day] = e.target.value.split('-').map(Number); window.setTestDate(year, month, day); } });
        document.getElementById('time-picker').addEventListener('change', (e) => { if (e.target.value) { const [hours, minutes] = e.target.value.split(':').map(Number); window.setTestTime(hours, minutes); } });
        document.getElementById('reset-datetime-btn').addEventListener('click', () => { window.resetDateTime(); document.getElementById('date-picker').value = ''; document.getElementById('time-picker').value = ''; });
        document.getElementById('reset-settings-btn').addEventListener('click', () => { if (confirm('Вы уверены, что хотите сбросить все настройки?')) { localStorage.removeItem('schedule_theme'); localStorage.removeItem('schedule_view'); localStorage.removeItem('schedule_version'); localStorage.removeItem('schedule_background_mode'); localStorage.removeItem('schedule_caching_enabled'); /* <-- Добавлено */ window.location.reload(); } });

        // Открытие окна "Что нового"
        whatsNewBtn.addEventListener('click', () => {
            whatsNewModal.classList.add('visible');
        });

        // Закрытие окна "Что нового" по кнопке
        closeWhatsNewBtn.addEventListener('click', () => {
            whatsNewModal.classList.remove('visible');
        });

        // Закрытие окна "Что нового" по клику на фон
        whatsNewModal.addEventListener('click', (e) => {
            if (e.target === whatsNewModal) {
                whatsNewModal.classList.remove('visible');
            }
        });
        // --- ИНИЦИАЛИЗАЦИЯ ПРИ ЗАГРУЗКЕ ---
        // Устанавливаем состояние переключателя кэширования
        cachingToggle.checked = localStorage.getItem('schedule_caching_enabled') === 'true';
         if (cachingToggle.checked) {
             precacheBackgrounds();
        }
        setupServiceWorker(); // Пытаемся запустить/удалить SW при каждой загрузке
        updateOfflineStatus(); // Проверяем статус сети при загрузке
        window.addEventListener('online', updateOfflineStatus);
        window.addEventListener('offline', updateOfflineStatus);

        applyTheme(localStorage.getItem('schedule_theme') || 'light');
        applyBackground();
        renderSchedule();
        updateView();
        setInterval(updateHighlight, 1000); 
        setInterval(tickTestTime, 1000);    
    });

    window.setTestDate = (year, month, day) => { const d = new Date(Date.UTC(year, month - 1, day)); const offset = d.getTimezoneOffset(); testDate = new Date(d.getTime() + (offset * 60 * 1000)); console.log(`Дата установлена на: ${testDate.toLocaleDateString()}`); renderSchedule(); };
    window.setTestTime = (hours, minutes) => { const d = testDate ? new Date(testDate) : new Date(); d.setHours(hours, minutes, 0, 0); testTime = d; console.log(`Время установлено на: ${d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`); updateHighlight(); };
    window.resetDateTime = () => { testDate = null; testTime = null; console.log("Дата и время сброшены к реальным."); renderSchedule(); };
</script>
</body>
</html>